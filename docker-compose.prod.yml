version: '3.9'

services:
  # ---------------------------------------------------------------------------
  # DATABASE
  # ---------------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    restart: always  # Автоматичний перезапуск, якщо впаде або після перезавантаження VPS
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
    env_file:
      - ./backend/.env.prod
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # BACKEND (Django + Gunicorn)
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    # Запускаємо Gunicorn. Переконайся, що config.wsgi відповідає назві твоєї папки з settings.py
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3
    volumes:
      - static_volume:/app/staticfiles  # Сюди збирається collectstatic
      - media_volume:/app/media         # Сюди користувачі вантажать фото
    env_file:
      - ./backend/.env.prod
    depends_on:
      db:
        condition: service_healthy

  # ---------------------------------------------------------------------------
  # FRONTEND BUILDER (Node.js helper)
  # ---------------------------------------------------------------------------
  # Цей контейнер запускається, збирає React/Vite і завершує роботу.
  # Результат (папка dist) зберігається у frontend_build_volume.
  frontend-builder:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - frontend_build_volume:/app/dist # Важливо! Vite за замовчуванням кладе білд в dist
      - /app/node_modules # Щоб не забруднювати хост-систему папкою node_modules
    # Команда: встановити залежності -> збілдити проєкт
    command: sh -c "npm install && npm run build"

  # ---------------------------------------------------------------------------
  # NGINX (Proxy & Static Server)
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
      # - "443:443" # Розкоментуєш, коли підключиш SSL
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      # Монтуємо том, куди frontend-builder поклав готові файли
      - frontend_build_volume:/usr/share/nginx/html
      # Монтуємо статику та медіа з бекенду
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      - backend
      - frontend-builder

# ---------------------------------------------------------------------------
# VOLUMES
# ---------------------------------------------------------------------------
volumes:
  postgres_prod_data: # База даних (вічна)
  static_volume:      # Django CSS/JS
  media_volume:       # User uploads
  frontend_build_volume: # React build files