# У Production ми не використовуємо upstream для frontend, бо він статичний!
upstream backend {
    server backend:8000;
}

server {
    listen 80;
    # На VPS тут буде твоє реальне доменне ім'я, але для local-staging підходить localhost
    server_name localhost;
    client_max_body_size 20M; # Обмеження розміру завантажуваних файлів (залишаємо)

    # 1. API: Всі запити на /api/ йдуть на Django/Gunicorn
    location /api/ {
        proxy_pass http://backend;
        # Заголовки залишаємо, вони важливі для безпеки та логування
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. Admin: Запити на /admin/ йдуть на Django/Gunicorn
    location /admin/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. Static files (CSS/JS Django Admin)
    # Nginx віддає їх самостійно з volume
    location /static/ {
        # Шлях до папки, яка прокинута в docker-compose volumes
        alias /app/staticfiles/;
        expires 30d; # Кешування на місяць
    }

    # 4. Media files (Завантажені адміном фото)
    # Nginx віддає їх самостійно з volume
    location /media/ {
        # Шлях до папки, яка прокинута в docker-compose volumes
        alias /app/media/;
    }

    # 5. Core Frontend (Збілджений React)
    # Всі інші запити обробляє Nginx самостійно.
    location / {
        # Вказуємо Nginx, де шукати HTML, CSS, JS
        root /usr/share/nginx/html;
        index index.html;
        # Важливо для SPA (React Router): якщо файл не знайдено, повертаємо index.html
        try_files $uri $uri/ /index.html;
    }
}